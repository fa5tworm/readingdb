<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Speech Library - Digital Rights Archive</title>
    <meta name="description" content="Access a curated collection of free speech books, human rights literature, and historical documents. Fight censorship through knowledge.">
    <meta name="keywords" content="free speech, human rights, books, download, open source, public domain, civil rights, democracy, freedom">
    <meta name="author" content="Free Speech Library">
    
    <!-- Fixed Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://via.placeholder.com/32x32/FFD700/1A1A1A?text=📚">
    <link rel="icon" type="image/png" sizes="16x16" href="https://via.placeholder.com/16x16/FFD700/1A1A1A?text=📚">
    <link rel="apple-touch-icon" sizes="180x180" href="https://via.placeholder.com/180x180/FFD700/1A1A1A?text=📚">
    <meta name="theme-color" content="#FFD700">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Free Speech Library - Digital Rights Archive">
    <meta property="og:description" content="Access free speech books and human rights literature. Knowledge is power.">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/FFD700/1A1A1A?text=FREE+SPEECH+LIBRARY">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gold: #FFD700;
            --dark-gold: #DAA520;
            --light-gold: #FFFACD;
            --dark-bg: #1A1A1A;
            --dark-gray: #2D2D2D;
            --light-gray: #F5F5F5;
            --text-dark: #1A1A1A;
            --text-light: #E0E0E0;
        }
        
        body {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--light-gold) 0%, #FFF8DC 100%);
            min-height: 100vh;
        }
        
        /* Header Styles - Gold and Dark Theme */
        header {
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--dark-gold) 100%);
            color: var(--dark-bg);
            padding: 2rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.1) 10px,
                rgba(0,0,0,0.1) 20px
            );
            animation: movePattern 20s linear infinite;
        }
        
        @keyframes movePattern {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .header-content {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        h1 {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 3px 3px 0px rgba(0,0,0,0.3);
            letter-spacing: -1px;
            color: var(--dark-bg);
        }
        
        .tagline {
            font-size: 1.4rem;
            font-style: italic;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.3);
            color: var(--dark-bg);
        }
        
        .mission {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
            font-weight: 300;
            color: var(--dark-bg);
        }
        
        /* Navigation */
        nav {
            background: var(--dark-bg);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
            gap: 1rem;
        }
        
        .search-container {
            flex: 1;
            max-width: 400px;
            position: relative;
        }
        
        #searchInput {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid var(--dark-gold);
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            background: white;
            transition: all 0.3s ease;
        }
        
        #searchInput:focus {
            border-color: var(--primary-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        
        .support-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .support-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--dark-bg);
            text-align: center;
            font-size: 0.9rem;
        }
        
        .coffee-btn {
            background: var(--primary-gold);
        }
        
        .paypal-btn {
            background: var(--dark-gold);
        }
        
        .support-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            background: var(--light-gold);
        }
        
        /* Main Content */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        /* Quick Stats Bar */
        .quick-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: white;
            border: 2px solid var(--primary-gold);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-gold);
            display: block;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stats {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border: 2px solid var(--primary-gold);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }
        
        .stats h2 {
            color: var(--dark-gold);
            margin-bottom: 0.5rem;
        }
        
        /* Book Grid */
        .books-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .book-card {
            background: white;
            border: 2px solid var(--primary-gold);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 215, 0, 0.3);
            border-color: var(--dark-gold);
        }
        
        .book-thumbnail {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--light-gold), #F5F5DC);
        }
        
        .book-info {
            padding: 1.5rem;
        }
        
        .book-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .book-author {
            color: var(--dark-gold);
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }
        
        .book-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .download-btn {
            flex: 1;
            background: linear-gradient(135deg, var(--primary-gold), var(--dark-gold));
            color: var(--dark-bg);
            border: none;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: block;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, var(--light-gold), var(--primary-gold));
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .pagination button {
            padding: 0.8rem 1rem;
            border: 2px solid var(--primary-gold);
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-dark);
        }
        
        .pagination button:hover,
        .pagination button.active {
            background: var(--primary-gold);
            color: var(--dark-bg);
            border-color: var(--dark-gold);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Google Ads Placeholder */
        .ad-container {
            background: var(--light-gold);
            border: 2px dashed var(--dark-gold);
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            border-radius: 10px;
        }
        
        /* View Toggle */
        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: white;
            border: 2px solid var(--primary-gold);
            padding: 0.3rem;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.2);
        }
        
        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: var(--text-dark);
        }
        
        .view-btn.active {
            background: var(--primary-gold);
            color: var(--dark-bg);
        }
        
        .sort-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .sort-select {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary-gold);
            border-radius: 20px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--text-dark);
        }
        
        /* List View */
        .books-container.list-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .books-container.list-view .book-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            height: auto;
        }
        
        .books-container.list-view .book-thumbnail {
            width: 80px;
            height: 100px;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .books-container.list-view .book-info {
            flex: 1;
            padding: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .books-container.list-view .book-actions {
            margin-left: 1rem;
        }
        
        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary-gold);
            color: var(--dark-bg);
            border: 2px solid var(--dark-gold);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
        }
        
        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .back-to-top:hover {
            background: var(--dark-gold);
            transform: translateY(-2px);
        }
        
        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--light-gold) 25%, var(--primary-gold) 50%, var(--light-gold) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Dark Mode */
        body.dark-mode {
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-gray) 100%);
            color: var(--text-light);
        }
        
        body.dark-mode .book-card {
            background: var(--dark-gray);
            color: var(--text-light);
            border-color: var(--dark-gold);
        }
        
        body.dark-mode .stats,
        body.dark-mode .view-toggle,
        body.dark-mode .sort-select,
        body.dark-mode .quick-stats {
            background: var(--dark-gray);
            color: var(--text-light);
            border-color: var(--dark-gold);
        }
        
        body.dark-mode .ad-container {
            background: var(--dark-gray);
            border-color: var(--dark-gold);
            color: var(--text-light);
        }
        
        body.dark-mode #searchInput {
            background: var(--dark-gray);
            color: var(--text-light);
            border-color: var(--dark-gold);
        }
        
        body.dark-mode .pagination button {
            background: var(--dark-gray);
            color: var(--text-light);
            border-color: var(--dark-gold);
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--primary-gold);
            border: 2px solid var(--dark-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 1001;
            color: var(--dark-bg);
        }
        
        .theme-toggle:hover {
            background: var(--dark-gold);
            transform: scale(1.1);
        }
        
        /* Footer */
        footer {
            background: var(--dark-bg);
            color: var(--text-light);
            padding: 2rem 0 1rem;
            margin-top: 4rem;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            text-align: center;
        }
        
        .social-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .social-link {
            color: var(--text-light);
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .social-link:hover {
            background: var(--primary-gold);
            color: var(--dark-bg);
            transform: translateY(-2px);
        }
        
        .footer-text {
            font-size: 0.9rem;
            opacity: 0.8;
            line-height: 1.8;
        }
        
        .footer-text a {
            color: var(--primary-gold);
            text-decoration: none;
        }
        
        .footer-text a:hover {
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 { 
                font-size: 2.5rem; 
            }
            
            .tagline { 
                font-size: 1.2rem; 
            }
            
            .nav-content { 
                flex-direction: column; 
                gap: 1rem; 
            }
            
            .support-buttons { 
                flex-direction: column; 
                width: 100%; 
            }
            
            .books-container { 
                grid-template-columns: 1fr; 
            }
            
            .books-container.list-view .book-card {
                flex-direction: column;
            }
            
            .books-container.list-view .book-thumbnail {
                margin-right: 0;
                margin-bottom: 1rem;
            }
            
            .books-container.list-view .book-info {
                flex-direction: column;
                text-align: center;
            }
            
            .books-container.list-view .book-actions {
                margin-left: 0;
                margin-top: 1rem;
            }
            
            .view-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-stats {
                padding: 0.5rem;
            }
            
            .stat-item {
                min-width: 80px;
            }
            
            .back-to-top {
                bottom: 1rem;
                right: 1rem;
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>FREE SPEECH LIBRARY</h1>
            <p class="tagline">"The only way to deal with an unfree world is to become so absolutely free that your very existence is an act of rebellion"</p>
            <p class="mission">Preserving the voices of liberty • Fighting censorship through knowledge • Empowering minds with timeless wisdom</p>
        </div>
    </header>
    
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">🌓</button>
    
    <nav>
        <div class="nav-content">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search books, authors, titles...">
            </div>
            <div class="support-buttons">
                <a href="#" class="support-btn coffee-btn" onclick="buyMeCoffee()">☕ Buy Me Coffee</a>
                <a href="#" class="support-btn paypal-btn" onclick="paypalSupport()">💳 Support via PayPal</a>
            </div>
        </div>
    </nav>
    
    <main>
        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-item">
                <span class="stat-number" id="totalBooks">0</span>
                <span class="stat-label">Free Books</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="totalAuthors">0</span>
                <span class="stat-label">Authors</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="totalDownloads">∞</span>
                <span class="stat-label">Downloads</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">100%</span>
                <span class="stat-label">Free</span>
            </div>
        </div>
        
        <div class="stats">
            <h2 id="bookCount">Loading books...</h2>
            <p>Free books available for download • No registration required • Open source knowledge</p>
        </div>
        
<!--         <div class="ad-container">
            <p>📢 Google Ads Space - Supporting Free Speech</p>
            <small>Your ad could be here • Contact us for ethical advertising opportunities</small>
        </div> -->
        
        <!-- View Controls -->
        <div class="view-controls">
            <div class="view-toggle">
                <button class="view-btn active" onclick="setView('grid')" data-view="grid">📊 Grid</button>
                <button class="view-btn" onclick="setView('list')" data-view="list">📋 List</button>
            </div>
            <div class="sort-controls">
                <label for="sortSelect">Sort by:</label>
                <select id="sortSelect" class="sort-select" onchange="sortBooks(this.value)">
                    <option value="title">Title A-Z</option>
                    <option value="title-desc">Title Z-A</option>
                    <option value="author">Author A-Z</option>
                    <option value="author-desc">Author Z-A</option>
                    <option value="id">Recently Added</option>
                </select>
            </div>
        </div>
        
        <div class="books-container" id="booksContainer">
            <!-- Books will be loaded here -->
        </div>
        
        <div class="pagination" id="pagination">
            <!-- Pagination will be loaded here -->
        </div>
        
        <div class="ad-container">
            <p>📚 More Free Resources Coming Soon</p>
            <small>Help us expand this library by supporting our mission</small>
        </div>
    </main>
    
    <footer>
        <div class="footer-content">
<!--             <div class="social-links">
                <a href="#" class="social-link" onclick="shareOn('twitter')" title="Share on Twitter">🐦</a>
                <a href="#" class="social-link" onclick="shareOn('facebook')" title="Share on Facebook">📘</a>
                <a href="#" class="social-link" onclick="shareOn('reddit')" title="Share on Reddit">📱</a>
                <a href="#" class="social-link" onclick="shareOn('telegram')" title="Share on Telegram">✈️</a>
            </div> -->
            <div class="footer-text">
                <p><strong>Free Speech Library</strong> - A digital sanctuary for uncensored knowledge</p>
                <p>All books are in the public domain or released under open licenses • Knowledge belongs to humanity</p>
                <p>© 2025 Free Speech Library • Built with ❤️ for freedom • <a href="#">Contact</a> • <a href="#">Privacy</a></p>
            </div>
        </div>
    </footer>
    
    <!-- Back to Top Button -->
    <button class="back-to-top" onclick="scrollToTop()" title="Back to top">↑</button>
    
    <script>
        // App State
        let currentPage = 1;
        const booksPerPage = 6;
        let filteredBooks = [];
        let allBooks = [];
        let booksData = null;
        let currentView = 'grid';
        let currentSort = 'title';
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            loadBooksData();
            initializeTheme();
            initializeScrollHandler();
        });
        
        // Load Books Data from JSON file
        async function loadBooksData() {
            try {
                showLoadingState();
                
                // Try to load from books.json file
                const response = await fetch('books.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                booksData = await response.json();
                allBooks = [...booksData.books];
                filteredBooks = [...booksData.books];
                
                initializeApp();
                hideLoadingState();
                
                trackEvent('Data', 'Books Loaded', `${allBooks.length} books`);
                
            } catch (error) {
                console.warn('Could not load books.json, using fallback data:', error);
                
                // Fallback data if JSON file is not available
                booksData = {
                    "books": [
                        {
                            "id": 1,
                            "title": "On Liberty",
                            "author": "John Stuart Mill",
                            "thumbnail": "https://via.placeholder.com/300x400/FFD700/1A1A1A?text=ON+LIBERTY",
                            "url": "https://www.gutenberg.org/files/34901/34901-pdf.pdf"
                        },
                        {
                            "id": 2,
                            "title": "Civil Disobedience",
                            "author": "Henry David Thoreau",
                            "thumbnail": "https://via.placeholder.com/300x400/DAA520/1A1A1A?text=CIVIL+DISOBEDIENCE",
                            "url": "https://www.gutenberg.org/files/71/71-pdf.pdf"
                        },
                        {
                            "id": 3,
                            "title": "The Rights of Man",
                            "author": "Thomas Paine",
                            "thumbnail": "https://via.placeholder.com/300x400/FFD700/1A1A1A?text=RIGHTS+OF+MAN",
                            "url": "https://www.gutenberg.org/files/3755/3755-pdf.pdf"
                        },
                        {
                            "id": 4,
                            "title": "Common Sense",
                            "author": "Thomas Paine",
                            "thumbnail": "https://via.placeholder.com/300x400/DAA520/1A1A1A?text=COMMON+SENSE",
                            "url": "https://www.gutenberg.org/files/147/147-pdf.pdf"
                        }
                    ]
                };
                
                allBooks = [...booksData.books];
                filteredBooks = [...booksData.books];
                
                initializeApp();
                hideLoadingState();
                
                trackEvent('Data', 'Fallback Loaded', 'Using embedded data');
            }
        }
        
        // Initialize App after data is loaded
        function initializeApp() {
            displayBooks();
            setupPagination();
            updateBookCount();
            updateStats();
            setupSearch();
            trackPageView();
        }
        
        // Loading State Management
        function showLoadingState() {
            const container = document.getElementById('booksContainer');
            const bookCount = document.getElementById('bookCount');
            
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 4rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📚</div>
                    <h3>Loading Free Speech Library...</h3>
                    <p>Preparing books for download...</p>
                </div>
            `;
            
            bookCount.textContent = 'Loading books...';
        }
        
        function hideLoadingState() {
            // Loading state will be replaced by displayBooks()
        }
        
        // Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Display Books (removed share button)
        function displayBooks() {
            const container = document.getElementById('booksContainer');
            const startIndex = (currentPage - 1) * booksPerPage;
            const endIndex = startIndex + booksPerPage;
            const booksToShow = filteredBooks.slice(startIndex, endIndex);
            
            container.className = `books-container ${currentView}-view`;
            
            container.innerHTML = booksToShow.map(book => `
                <div class="book-card">
                    <img src="${book.thumbnail}" alt="${book.title}" class="book-thumbnail" 
                         onerror="this.src='https://via.placeholder.com/300x400/FFFACD/666666?text=📚+${encodeURIComponent(book.title.substring(0,20))}'">
                    <div class="book-info">
                        <div class="book-details">
                            <h3 class="book-title">${book.title}</h3>
                            <p class="book-author">by ${book.author}</p>
                        </div>
                        <div class="book-actions">
                            <a href="${book.url}" class="download-btn" onclick="trackDownload('${book.title}', '${book.author}')" target="_blank" rel="noopener">
                                📥 Download
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Setup Search
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = e.target.value.toLowerCase().trim();
                    filterBooks(query);
                    trackEvent('Search', 'Query', query || 'Empty');
                }, 300);
            });
        }
        
        // Filter Books function
        function filterBooks(query = '') {
            if (!query) {
                filteredBooks = [...allBooks];
            } else {
                filteredBooks = allBooks.filter(book => 
                    book.title.toLowerCase().includes(query) ||
                    book.author.toLowerCase().includes(query)
                );
            }
            
            sortBooks(currentSort, false);
            currentPage = 1;
            displayBooks();
            setupPagination();
            updateBookCount();
        }
        
        // Update Statistics
        function updateStats() {
            document.getElementById('totalBooks').textContent = allBooks.length;
            
            const uniqueAuthors = [...new Set(allBooks.map(book => book.author))];
            document.getElementById('totalAuthors').textContent = uniqueAuthors.length;
        }
        
        // View Toggle Functions
        function setView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                }
            });
            
            displayBooks();
            trackEvent('UI', 'View Change', view);
        }
        
        // Sort Books
        function sortBooks(sortBy, shouldUpdate = true) {
            currentSort = sortBy;
            
            switch(sortBy) {
                case 'title':
                    filteredBooks.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'title-desc':
                    filteredBooks.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'author':
                    filteredBooks.sort((a, b) => a.author.localeCompare(b.author));
                    break;
                case 'author-desc':
                    filteredBooks.sort((a, b) => b.author.localeCompare(a.author));
                    break;
                case 'id':
                    filteredBooks.sort((a, b) => b.id - a.id);
                    break;
                default:
                    filteredBooks.sort((a, b) => a.title.localeCompare(b.title));
            }
            
            if (shouldUpdate) {
                currentPage = 1;
                displayBooks();
                setupPagination();
                trackEvent('UI', 'Sort Change', sortBy);
            }
        }
        
        // Theme Functions
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            trackEvent('UI', 'Theme Toggle', isDark ? 'dark' : 'light');
        }
        
        // Scroll Functions
        function initializeScrollHandler() {
            const backToTopBtn = document.querySelector('.back-to-top');
            
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            });
        }
        
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            trackEvent('UI', 'Scroll', 'Back to Top');
        }
        
        // Enhanced Error Handling with User Feedback
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f56565;
                color: white;
                padding: 1rem;
                border-radius: 8px;
                z-index: 10000;
                max-width: 300px;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                document.body.removeChild(errorDiv);
            }, 5000);
        }
        
        // Enhanced Performance Monitoring
        function measurePerformance() {
            if (window.performance) {
                const navigation = performance.getEntriesByType('navigation')[0];
                if (navigation) {
                    const metrics = {
                        'DNS Lookup': navigation.domainLookupEnd - navigation.domainLookupStart,
                        'TCP Connection': navigation.connectEnd - navigation.connectStart,
                        'Request': navigation.responseStart - navigation.requestStart,
                        'Response': navigation.responseEnd - navigation.responseStart,
                        'DOM Processing': navigation.domContentLoadedEventEnd - navigation.responseEnd,
                        'Total Load Time': navigation.loadEventEnd - navigation.navigationStart
                    };
                    
                    Object.entries(metrics).forEach(([key, value]) => {
                        if (value > 0) {
                            trackEvent('Performance', key, Math.round(value) + 'ms');
                        }
                    });
                }
            }
        }
        
        // Setup Pagination
        function setupPagination() {
            const totalPages = Math.ceil(filteredBooks.length / booksPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹ Previous</button>`;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<button disabled>...</button>';
                }
            }
            
            // Next button
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ›</button>`;
            
            paginationContainer.innerHTML = paginationHTML;
        }
        
        // Change Page
        function changePage(page) {
            const totalPages = Math.ceil(filteredBooks.length / booksPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayBooks();
            setupPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            trackEvent('Navigation', 'Page Change', `Page ${page}`);
        }
        
        // Update Book Count
        function updateBookCount() {
            const bookCount = document.getElementById('bookCount');
            bookCount.textContent = `${filteredBooks.length} Free Books Available`;
        }
        
        // Share Functions (simplified - removed individual book share buttons)
        function shareOn(platform, customText = '', customUrl = '') {
            const text = customText || 'Discover free speech books and fight censorship with knowledge - Free Speech Library';
            const url = customUrl || window.location.href;
            
            const shareUrls = {
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
                reddit: `https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(text)}`,
                telegram: `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`
            };
            
            if (shareUrls[platform]) {
                window.open(shareUrls[platform], '_blank', 'width=600,height=400');
                trackEvent('Social', 'Platform Share', platform);
            }
        }
        
        // Support Functions
        function buyMeCoffee() {
            // Replace with actual Buy Me a Coffee URL
            window.open('https://www.buymeacoffee.com/freespeechlibrary', '_blank');
            trackEvent('Support', 'Buy Me Coffee', 'Click');
        }
        
        function paypalSupport() {
            // Replace with actual PayPal donation URL
            window.open('https://www.paypal.com/donate/?hosted_button_id=YOUR_BUTTON_ID', '_blank');
            trackEvent('Support', 'PayPal', 'Click');
        }
        
        // Analytics Functions
        function trackPageView() {
            if (typeof gtag !== 'undefined') {
                gtag('config', 'GA_MEASUREMENT_ID', {
                    page_title: 'Free Speech Library - Digital Rights Archive',
                    page_location: window.location.href
                });
            }
        }
        
        function trackDownload(title, author) {
            trackEvent('Download', 'Book', `${title} by ${author}`);
        }
        
        function trackEvent(category, action, label) {
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            }
            console.log(`Analytics: ${category} - ${action} - ${label}`);
        }
        
        // SEO and Meta Updates
        function updateMetaForSearch(query) {
            if (query) {
                document.title = `${query} - Free Speech Library`;
                const metaDesc = document.querySelector('meta[name="description"]');
                if (metaDesc) {
                    metaDesc.content = `Search results for "${query}" in our free speech books collection. Download open-source literature and fight censorship.`;
                }
            } else {
                document.title = 'Free Speech Library - Digital Rights Archive';
            }
        }
        
        // Error Handling
        window.addEventListener('error', function(e) {
            console.error('Application Error:', e.error);
            trackEvent('Error', 'JavaScript', e.message);
        });
        
        // Performance Monitoring
        window.addEventListener('load', function() {
            setTimeout(() => {
                measurePerformance();
            }, 100);
        });
        
        // Enhanced Error Handling
        window.addEventListener('error', function(e) {
            console.error('Application Error:', e.error);
            showErrorMessage('Something went wrong. Please refresh the page.');
            trackEvent('Error', 'JavaScript', e.message);
        });
        
        // Service Worker Registration (Progressive Web App)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                        trackEvent('PWA', 'Service Worker', 'Registered');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }
        
        // Keyboard Navigation
        document.addEventListener('keydown', function(e) {
            // Alt + S for search
            if (e.altKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Alt + T for theme toggle
            if (e.altKey && e.key === 't') {
                e.preventDefault();
                toggleTheme();
            }
            
            // Arrow keys for pagination
            if (e.key === 'ArrowLeft' && e.ctrlKey) {
                e.preventDefault();
                if (currentPage > 1) changePage(currentPage - 1);
            }
            if (e.key === 'ArrowRight' && e.ctrlKey) {
                e.preventDefault();
                const totalPages = Math.ceil(filteredBooks.length / booksPerPage);
                if (currentPage < totalPages) changePage(currentPage + 1);
            }
        });
        
        // Print Styles Handler
        window.addEventListener('beforeprint', function() {
            document.body.classList.add('printing');
            trackEvent('UI', 'Print', 'Page');
        });
        
        window.addEventListener('afterprint', function() {
            document.body.classList.remove('printing');
        });
    </script>
    
    <!-- PWA Manifest -->
    <script>
        // Create and inject manifest.json dynamically
        const manifestData = {
            "name": "Free Speech Library",
            "short_name": "FSL",
            "description": "Access free speech books and fight censorship through knowledge",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#FFFACD",
            "theme_color": "#FFD700",
            "orientation": "portrait-primary",
            "icons": [
                {
                    "src": "https://via.placeholder.com/192x192/FFD700/1A1A1A?text=📚",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://via.placeholder.com/512x512/FFD700/1A1A1A?text=📚",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ],
            "categories": ["books", "education", "reference"],
            "lang": "en",
            "dir": "ltr"
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        
        const linkElement = document.createElement('link');
        linkElement.rel = 'manifest';
        linkElement.href = manifestURL;
        document.head.appendChild(linkElement);
        
        // Performance tracking
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (window.performance && window.performance.timing) {
                    const loadTime = window.performance.timing.loadEventEnd - window.performance.timing.navigationStart;
                    trackEvent('Performance', 'Page Load Time', Math.round(loadTime / 1000) + 's');
                }
            }, 0);
        });
    </script>
</body>
</html>
